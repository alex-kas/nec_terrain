### Руководство по режиму 9008 для NEC Terrain

**РЕБЯТА, ЭТО ЕСЛИ ВЫ убили свой аппарат программно, а не скинули с 10-го этажа**

**Это круто, но не сложно**

**Это под LINUX, windows пользователи должны разбираться сами**

**Эта инструкция сугубо для NEC Terrain**

#### Что такое 9008

Это режим, в котором внешний usb порт телефона нумеруется, как `05c6:9008` и распознается, как серийный порт, то есть ttySn (COMn в windows). Это происходит в случае, когда стратовые разделы испорчены и ни boot ни recovery разделы не получают управления. Например, вы удалили aboot ... В этом случае телефон после старта ни показывает _НИЧЕГО_. Однако, вполне верятно, что он еще живой.

В этом состоянии при подключении к компьютеру по usb вы не видите _НИЧЕГО_. Вам нужно активировать режим 9008, который, судя по всему, на самом деле **ПОСЛЕДНИЙ** шанс. Но шанс довольно стойкий. В этом режиме можно записать по-новой внутреннюю flash-память с помощью простого срипта в linux. (В windows вам нужны специальные драйверы `qs9008.tar.gz` и программа QPST. QPST нужно искать или спросить меня частным образом.) Важно, что ядро linux должно поддерживать серийные tty через usb (ttyS).

Другой случай, когда режим 9008 может быть полезен, - когда что-то не так в системе, телефон вроде грузится, но, например, входит в режим постоянной перезагрузки, из которой нет выхода, и, скажем, нет нормального режима восстановления (recovery). В этом случае вы можете хотеть переписать recovery или даже весь системный каталог, не загружая телефон. Режим 9008  - это выход из ситуации.

Все упоминаемые файлы находятся в этом каталоге.

#### Активация режима 9008

* Выньте батарейку и usb провод из телефона
* Отклейте стикер на котором написан номер IMEI
* Откроются разные контакты, найдите группу из 4-х (на `photo1.jpg` они очерчены красным кругом.). 2 в середине называются GND и ENG_BOOT от слов ground (земля) и engineering_boot (инженерная загрузка) (на `photo2.jpg` показаны красными стрелками)
* Подсоедините телефон в этом состоянии (без батареи) к компьютеру
* Проверьте с помощью команды `lsusb`, что телефон _не_ виден, так по идее должно быть
* Замкните на короткое время контакты GND и ENG_BOOT, для этого вполне подойдет пинцет от швейцарского ножа
* Проверьте с помощью команды `lsusb` что теперь телефон **виден** как `05c6:9008`; если нет, закоротите контакты более аккуратно
* Кажется, что касание соседних контактов не имеет никакого эффекта (в том числе никакого опасного), я пробовал
* Также, вы **не должны** держать контакты замкнутыми и **не должны** вставлять батарею

Мои благодарности за указание на нужные контакы пользавотелю VANOLEO с xda. Спасибо!

Вы только что доказали, что ваш телефон еще **ЖИВ!**

Замечание 1: если никакого соединения так и не появляется, ваш телефон видать реально мертв. Мои соболезнования.

Замечание 2: режим 9008 можно активировать и на здоровом аппарате (так, на всякий случай).

#### 1-я стадия

Телефон жив, но еще пока не подчиняется. Нужен специальный файл. Он называется программер и обычно имеет имя наподобие `MPRG8960.bin`. Он может быть в формате `HEX`, например `MPRG8960.HEX`. На этот случай есть конвертор `hex2bin`. `M` в имени - некий индекс, `8960` - код чипа QualComm. Основная трудность, что этот файл зависит как минимум от производителя телефона (то есть файл разный, даже если чип один, у motorola и samsung). У меня заняло более месяца, чтобы найти нужный файл, видать от Casio 811, который в результате подошел. Похоже, что мне повезло! Файл переименован в  `MPRG8960NECTerrain.bin`, чтобы подчеркнуть его специфичность для NEC Terrain.

Технология такова. В режиме 9008 телефон все еще бесполезен. Он может принимать только ограниченный набор комманд и данных для обработки первичным модулем процессора. Необходимо переключить телефон в другой режим (не 9006, однако, как следует из многих итсочников) в котором он сможет писать данные на внутреннюю flash-память (я считаю, что для NEC Terrain это не режим 9006, так как внутренняя flash-память не становится видна, как SDcard). Для достижения этой цели в телефон нужно загрузить тот самый файл `MPRG8960NECTerrain.bin` при помощи протокола серийного порта, а потом передать команду исполнить файл, как программу внутри телефона. Если все пройдет успешно, то потом можно использовать серийный протокол для записи данных на внутреннюю flash-память.

Для нас команда выглядит
```
sudo ./stage1.py -v MPRG8960NECTerrain.bin
```
Она должна исполняться из-под пользователя root, `-v` для подробного вывода (в принципе, не критично). Если нет ошибок, последняя строка вывода будет `Done`. Для работы скрипта необходимы установленные `python` и `pyserial`. Теперь надо подождать. Я не смог понять сколько, но хоть несколько секунд, прежде чем переходить ко 2-й стадии.

**НЕ трогайте кабель, телефон должен оставаться соединенным с компьютером, НЕ вставляйте батарею, РАССЛАБЬТЕСЬ**

#### 2-я стадия

Здесь все более запутанно. Для начала: вы готовы писать на внутреннюю flash-память. Я взял скрипты из темы Droid Ultra unbrick, созданной VBlack на xda. В общем, я решил сохранить использованную стратегию. Она заключается в переписывании внутренней flash-памяти по разделам (partitions). Вы должны указать, какие разделы переписывать, и иметь их образы.

То есть, вам необходим файл с таблицей разделов flash-памяти телефона. Однако, в данный момент вы уже не можете извлечь его из телефона, так как телефон почти мертвый. Единственный выход - это работать с файлом таблицы разделов другого (нормального) телефона. Здесь есть такой файл, называется `gpt.txt`.

Что **НАИБОЛЕЕ** важно, - вы **ДОЛЖНЫ** понимать, какой раздел вы хотите перезаписать. В моем случае я запортил `aboot`, эксперементируя с новым ядром, то есть нужно было восстановить `aboot`. На телефоне друга я перезаписал старое бесполезное `recovery` на новое, чтобы восстановить системный раздел. Как общее правило, я думаю, что:

**Если вы - это не я, то вы скорее всего трогали телефон по моим инструкциям (или использовали программу terroot, которая тоже была написана по моему методу). Тем самым, разделы либо как на изначальном фабричном телефоне (то есть вы его не трогали серьезно вообще), либо там, где они должны быть после использования моих описаний.**

То есть, файл `gpt.txt`, находящийся здесь, вполне подходит для решения большинства задач (он указывает раздел `recovery` в месте, в котором он находится _после_ рутинга по моим описаниям или с использованием terroot). Если что вы и захотите переписать, то это будет что-то из набора `sbl1,2,3`, `aboot`, `tz`, `rpm` или `recovery`, как мне кажется.

Если у вас есть ваша таблица разделов в виде бинарного файла, вы можете использовать `gpt_parser.py` для переделывания ее в текстовую таблицу.

В файле `gpt.txt` первая колонка указывает смещение раздела в байтах, вторая - имя раздела, третья - размер раздела

**!!!ВЫ НЕ ДОЛЖНЫ ДАЖЕ ДУМАТЬ О ПЕРЕЗАПИСЫВАНИИ РАЗДЕЛОВ `modemst1` и `modemst2` для каких угодно целей!!!**

Как только вы точно понимаете, что конкретно хотите перезаписать на flash-памяти телефона, вы должны отредактировать скрипт `stage2.py`. Вы ищите следующее присваивание (строка 42)
```
BOOT_PARTITIONS = ("recovery",)
```
и изменяете `recovery` на имя того раздела, который хотите перезаписать. Имя раздела должно быть написано **АБСОЛЮТНО** также, как оно записано в таблице разделов. Если вы хотите перезаписать один раздел, вы **оставляете** запятую после закрывающей кавычки, это верный синтакс. Есди вы хотите перезаписать более одного раздела, то сформируйте строку, как в закомментированном примере в строке 41. Например
```
BOOT_PARTITIONS = ("recovery","aboot")
```
В этом случае запятая после последнего имени не нужна.

Для каждого упомянутого в списке `BOOT_PARTITION` раздела должен существовать отдельный файл образа с расширением `.img`, то есть, например, `recovery.img`, `aboot.img`, и так далее. В именах регистр букв различается, и имена **ДОЛЖНЫ** совпалать с названиями разделов в таблице разделов.

В скрипте заложена возможность перезаписать на внутренней flash-памяти саму таблицу разделов. Я лично не пользовался, хотя выглядит прямолинейно.

Наконец, вы отредактировали переменную `BOOT_PARTITION`, все `.img` файлы образов на месте, таблица разделов а ля `gpt.txt` пристутствует. Можем выполнять 2-ю стадию. Команда выглядит 
```
sudo ./stage2.py -v -ptf gpt.txt
```
Опять, из-под root, `-v` для подробного вывода на экран, `-ptf` - опция указания файля таблицы разделов. Будьте аккуратны, `-pt` зарезервировано как опция, указывающая на желание перезаписать саму таблицу разделов.

Если скрипт закончил работу быстро, упомяная ошибки, то корее всего прошло мало времени после 1-й стадии. Возможно, будет сказано, что телефон все еще в 1-й стадии. Тогда нужно вернуться и выполнить команду 1-й стадии. Но нужно иметь ввиду, что если и вправду возникли ошибки, то серийный модем в телефоне будет перегружен. В этом случае необходимо:
* проверить с помощью команды `lsusb`, что подсоединение ушло (нет устройства с номером `05c6:9008`)
* по новой закоротить контакты GND и ENG_BOOT
* проверить, что нужное подсоединение возникло и вернуться к команде 1-й стадии
* если нет соединения, вынуть usb кабель и начать 1-ю стадию с самого начала

Обычно, запись идет медленно (серийный порт). Поэтому, опция `-v` полезна, чтобы видеть прогресс. В случае успеха последней строкой вывода будет `Done`.

Если в этот момент вы поняли, что хотите перезаписать еще какие-то разделы, возвращайтесь к началу 1-й стадии, так как модем в телефоне в конце перегружается.

#### СДЕЛАНО!

Если вы делали то, что хотели сделать, вы должны получить то, что ожидали.

Я воскресил 2 аппарата из дэ факто мертвых.

**УДАЧИ!**
